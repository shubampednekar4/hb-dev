"use strict";const countTabs=()=>{return document.querySelectorAll(".location-tab-btn").length},removeBtn=document.getElementById("location-delete-btn");let tabCount=countTabs();$(function(){document.querySelectorAll("#location-card .location-select2").forEach(e=>{let t=document.getElementById(e.dataset.parent);e.multiple?$(`#${e.id}`).select2({dropdownParent:$(t),tags:!0,width:"100%"}):$(`#${e.id}`).select2({dropdownParent:$(t),width:"100%"})})}),document.querySelectorAll(".edit-btn").forEach(e=>{e.addEventListener("click",()=>{"false"===e.dataset.formOpen?(e.classList.remove("btn-primary"),e.classList.add("btn-success"),e.textContent="Save",e.dataset.formOpen="true"):(e.classList.add("btn-primary"),e.classList.remove("btn-success"),e.textContent="Edit",e.dataset.formOpen="false","franchise"===e.dataset.formType?swal.fire({title:"Saving Franchise Information",text:"Please wait while we save the franchise information...",icon:"info",didOpen:()=>(swal.showLoading(),saveFranchiseData().then(e=>{fillFranchiseData(e),swal.fire({title:"Success",text:"Franchise information was successfully saved!",icon:"success"})}).catch(e=>{swal.hideLoading(),swal.fire({title:"Something Went Wrong",text:"We could not save the franchise information.",icon:"error",didOpen:()=>swal.showValidationMessage(e)})})),showConfirmButton:()=>!swal.isLoading(),showCancelButton:!1,allowOutsideClick:()=>!swal.isLoading()}):swal.fire({title:"Saving Operator Information",text:"Please wait while we save the operator information...",icon:"info",didOpen:()=>(swal.showLoading(),saveOperatorData().then(e=>{fillOperatorData(e),swal.fire({title:"Success",text:"Operator information was successfully saved!",icon:"success"})}).catch(e=>{swal.hideLoading(),swal.fire({title:"Something Went Wrong",text:"We could not save the operator information",icon:"error",didOpen:()=>swal.showValidationMessage(e)})})),showConfirmButton:()=>!swal.isLoading(),showCancelButton:!1,allowOutsideClick:()=>!swal.isLoading()}))})}),document.getElementById("add-location-btn").addEventListener("click",()=>{swal.fire({title:"One Moment",text:"Please wait while we gather everything.",didOpen:()=>{swal.showLoading(),getStates().then(e=>{swal.hideLoading(),swal.fire({title:"Add Location",html:renderLocationForm(e),showCloseButton:!0,confirmButtonText:"Done",didOpen:()=>{let e=$(".swal2-container");$(".location-select").each(function(){$(this).select2({dropdownParent:e,width:"100%",tags:"multiple"===$(this).attr("multiple")})})},preConfirm:()=>{if(validateForm("location-form"))return saveNewLocationData().catch(e=>{swal.showValidationMessage(`Issue: ${e}`)});swal.showValidationMessage("Please check your information.")}}).then(e=>{e.isConfirmed&&(swal.fire({title:"Success",text:`The "${e.value.location_name}" location has been added.`,icon:"success"}),getStates().then(t=>{let a=[];t.forEach(e=>{a.push({value:e.state_id,text:e.full_name})}),fillNewLocationData(e.value,a),renewEditBtn()}).catch(e=>handleGeneralError(e)))})})},allowOutsideClick:()=>!swal.isLoading()})});const renewEditBtn=()=>{const e=document.querySelectorAll(".variable-edit-btn"),t=document.querySelectorAll(".location-tab"),a=document.querySelectorAll(".location-toggle");t.forEach(t=>{$(t).on("shown.bs.tab",function(){e.forEach(e=>{e.dataset.currentTab=this.dataset.locationId})})});let n=document.getElementById("variable-edit-btn").dataset.currentTab;a.forEach(e=>{$(e).addClass("collapse"),e.classList.contains("location-form")||$(e).collapse("show")});let o=$(`#location-info-${n}`),i=$(`#location-form-${n}`);o.addClass("collapse show"),i.addClass("collapse");document.querySelectorAll(".location-info").forEach(e=>{$(e).on("show.bs.collapse",()=>{let e=document.getElementById("variable-edit-btn");e.classList.remove("btn-success"),e.classList.add("btn-primary"),e.textContent="Edit"}).on("hide.bs.collapse",()=>{let e=document.getElementById("variable-edit-btn");e.classList.add("btn-success"),e.classList.remove("btn-primary"),e.textContent="Save"}).on("shown.bs.collapse",()=>{document.getElementById("variable-edit-btn").dataset.save="false"}).on("hidden.bs.collapse",()=>{document.getElementById("variable-edit-btn").dataset.save="true"})}),document.getElementById("variable-edit-btn").addEventListener("click",function(){let e=document.getElementById("variable-edit-btn").dataset.currentTab,t=$(`#location-info-${e}`),a=$(`#location-form-${e}`);t.collapse("toggle"),a.collapse("toggle")})};renewEditBtn();const saveFranchiseData=async()=>{let e=new FormData(document.getElementById("franchise-form-element")),t=new URLSearchParams(e),a=await fetch("/franchises/save-info",{body:t,headers:{Accept:"application/json","X-Csrf-Token":csrfToken},method:"post"});if(!a.ok)throw new Error("Server returned issue with save");return a.json()},fillFranchiseData=e=>{let t=document.createElement("span");switch(t.classList.add("badge"),e.franchise_status){case"Active":t.classList.add("badge-success"),t.textContent="Open";break;case"Inactive":t.classList.add("badge-danger"),t.textContent="Closed";break;case"For Sale":t.classList.add("badge-warning"),t.textContent="For Sale";break;default:t.classList.add("badge-danger"),t.textContent="Something Went Wrong"}document.getElementById("staticTitle").textContent=e.franchise_name,document.getElementById("staticFranchiseName").textContent=e.franchise_name,document.getElementById("staticFranchiseStatus").innerHTML="",document.getElementById("staticFranchiseStatus").appendChild(t),document.getElementById("staticFranchiseStateOwnerName").textContent=e.state_owner.full_name,document.getElementById("staticFranchiseDescription").textContent=e.franchise_description,document.getElementById("staticFranchiseTerritories").textContent=e.franchise_number_of_territories,document.title=`Heaven's Best Â» ${e.franchise_name}`},saveOperatorData=async()=>{let e=new FormData(document.getElementById("operator-form-element")),t=new URLSearchParams(e),a=await fetch("/operators/save-info",{body:t,headers:{Accept:"application/json","X-Csrf-Token":csrfToken},method:"post"});if(!a.ok)throw new Error("Server returned issue with save");return a.json()},fillOperatorData=e=>{let t=document.querySelectorAll(".staticOp"),a=document.getElementById("staticOpName"),n=document.getElementById("staticOpEmail"),o=document.getElementById("staticOpPhone"),i=document.getElementById("staticOpAddress"),l=document.getElementById("staticOpUsername"),c=document.createElement("a"),s=document.createElement("a"),d=document.createElement("a"),r=document.createElement("a");t.forEach(e=>e.innerHTML=""),c.href=`/operators/view/${e.operator_id}`,c.textContent=e.full_name,a.appendChild(c),s.href=`mailto:${e.operator_email}`,s.textContent=e.operator_email,n.appendChild(s),d.href=`tel:${e.operator_phone}`,d.textContent=e.operator_phone,o.appendChild(d),i.innerHTML=`${e.operator_address}<br/>${e.operator_city}, ${e.state.abbrev} ${e.operator_zip}`,r.href=`/users/view/${e.user_id}`,r.textContent=e.user.user_username,l.appendChild(r)},saveNewLocationData=async()=>{let e=new FormData(document.getElementById("location-form")),t=new URLSearchParams(e),a=await fetch("/locations/add",{method:"post",body:t,headers:{"X-Csrf-Token":csrfToken,Accept:"application/json"}});if(!a.ok)throw new Error("Could not save location");return a.json()},fillNewLocationData=(e,t)=>{let a=document.createElement("div"),n=document.createElement("div"),o=document.createElement("form"),i=document.getElementById("locationTabs"),l=document.getElementById("location-panes"),c=[],s=[];e.assoc_cities.forEach(e=>c.push(e.city_name)),e.assoc_zips.forEach(e=>s.push(e.zip_code)),a.classList.add("location-toggle","show","location-info"),a.id=`location-info-${e.location_id}`,n.classList.add("location-form","location-toggle"),n.id=`location-form-${e.location_id}`,o.method="post",o.action=`/franchises/view/${e.franchise_id}`;[createInfoGroup({name:"Name",label:"Location Name",id:e.location_id,value:e.location_name}),createInfoGroup({name:"Address",label:"Address",id:e.location_id,value:`<br/>${e.location_address}<br/>${e.main_city.city_name}, ${e.state.abbrev} ${e.main_zip.zip_code}`}),createInfoGroup({name:"Cities",label:"Cities",id:e.location_id,value:c.join(", ").toString()}),createInfoGroup({name:"Zips",label:"Zip Codes",id:e.location_id,value:s.join(", ").toString()})].forEach(e=>a.appendChild(e));let d=[createTextInput({name:"location_name",required:!0,labelText:"Location Name",idEnd:"name",locationId:e.location_id,value:e.location_name}),createTextInput({name:"location_address",required:!0,labelText:"Address",idEnd:"address",locationId:e.location_id,value:e.location_address}),createTextInput({name:"main_city[city_name]",required:!0,labelText:"City",idEnd:"city",locationId:e.location_id,value:e.main_city.city_name}),createSelectInput({name:"state_id",required:!0,labelText:"State",idEnd:"state",locationId:e.location_id,options:t,value:e.state_id},!1),createTextInput({name:"main_zip[zip_code]",required:!0,labelText:"Zip Code",idEnd:"zip",locationId:e.location_id,value:e.main_zip.zip_code}),createSelectInput({name:"cities[city_name]",required:!0,labelText:"Cities",idEnd:"cities-city-name",locationId:e.location_id,values:e.assoc_cities.map(e=>({value:e.city_id,text:e.city_name}))}),createSelectInput({name:"zips[zip_code]",required:!0,labelText:"Zips",idEnd:"zips-zip-codes",locationId:e.location_id,values:e.assoc_zips.map(e=>({value:e.zip_id,text:e.zip_code}))})];o.appendChild(createHiddenInput({name:"location_id",value:e.location_id})),d.forEach(e=>o.appendChild(e)),n.appendChild(o),l.appendChild(createLocationPane(e.location_id,a,n)),i.insertBefore(createLocationTab(e.location_id,e.location_name),document.getElementById("add-location-btn"));document.querySelectorAll(`#location-form-${e.location_id} .select2`).forEach(t=>{t.multiple?$(t).select2({dropdownParent:$(`#location${e.location_id}${t.id}Parent`),tags:!0,width:"100%"}):$(t).select2({dropdownParent:$(`#location${e.location_id}${t.id}Parent`),width:"100%"})}),removeBtn.disabled=!1,removeBtn.innerText="Remove",tabCount++,renewEditBtn(),$(`#location${e.location_id}-tab`).tab("show")},createTextInput=e=>{let t=document.createElement("input");return t.type="text",t.id=`location-${e.locationId}-${e.idEnd}`,t.classList.add("form-control"),t.name=e.name,t.required=!0,t.value=e.value,addToGroup(t,e.labelText)},createSelectInput=(e,t=!0)=>{let a=document.createElement("select");if(a.id=`location-${e.locationId}-${e.idEnd}`,a.classList.add("select2"),a.name=e.name,a.required=e.required,t){a.multiple=!0;let t=[];e.values.forEach(e=>{let a=document.createElement("option");a.value=e.value,a.textContent=e.text,a.selected=!0,t.push(a)}),t.forEach(e=>a.appendChild(e))}else{e.options.forEach(t=>{let n=document.createElement("option");n.value=t.value,n.textContent=t.text,n.value===e.value&&(n.selected=!0),a.appendChild(n)})}return addToGroup(a,e.labelText,`location${e.locationId}${a.id}Parent`)},addToGroup=(e,t,a=null)=>{let n=document.createElement("label"),o=document.createElement("div"),i=document.createElement("div"),l=document.createElement("div"),c=document.createElement("div");return n.setAttribute("for",e.id),n.textContent=t,o.classList.add("invalid-input"),i.classList.add("form-group"),a&&(i.id=a),c.classList.add("form-row"),l.classList.add("col-12"),i.appendChild(n),i.appendChild(e),i.appendChild(o),l.appendChild(i),c.appendChild(l),c},createInfoGroup=e=>{let t=document.createElement("div"),a=document.createElement("div"),n=document.createElement("span"),o=document.createElement("span");return t.classList.add("row"),a.classList.add("col-12","lead","my-2"),n.classList.add("font-weight-bold"),n.textContent=`${e.label}: `,o.id=`staticLocation${e.name}-${e.id}`,"address"===e.name?o.innerHTML="<br/>"+e.value:o.innerHTML=e.value,a.appendChild(n),a.appendChild(o),t.appendChild(a),t},createLocationTab=(e,t)=>{let a=document.createElement("li"),n=document.createElement("a");return a.classList.add("nav-item","location-tab"),a.dataset.locationId=e,n.href=`#location${e}`,n.classList.add("nav-link","location-tab-btn"),n.dataset.toggle="tab",n.dataset.key=e,n.id=`location${e}-tab`,n.textContent=t,a.appendChild(n),a},createLocationPane=(e,t,a)=>{let n=document.createElement("div");return n.classList.add("tab-pane"),n.id=`location${e}`,n.appendChild(t),n.appendChild(a),n},createHiddenInput=e=>{let t=document.createElement("input");return t.type="hidden",t.name=e.name,t.value=e.value,t},saveLocationData=async e=>{let t=await fetch("/locations/edit",{method:"post",headers:{Accepts:"application/json","X-Csrf-Token":csrfToken},body:e});if(!t.ok)throw new Error("Could not update existing location");return t.json()},fillLocationData=(e,t)=>{let a=document.getElementById(`staticLocationName-${e}`),n=document.getElementById(`staticLocationAddress-${e}`),o=document.getElementById(`staticLocationCities-${e}`),i=document.getElementById(`staticLocationZips-${e}`),l=t.assoc_cities.map(e=>e.city_name),c=t.assoc_zips.map(e=>e.zip_code);a.textContent=t.location_name,n.innerHTML=`${t.location_address}<br/>${t.main_city.city_name}, ${t.state.abbrev} ${t.main_zip.zip_code}`,o.textContent=l.join(", "),i.textContent=c.join(", ")};document.getElementById("variable-edit-btn").addEventListener("click",function(){let e=this.dataset.currentTab,t=document.getElementById(`location-form-${e}`),a=document.querySelector(`#${t.id} form`),n=new FormData(a),o=new URLSearchParams(n);"true"===this.dataset.save?(1===tabCount?(removeBtn.innerText="Cannot Remove Only Location",removeBtn.disabled=!0):(removeBtn.innerText="Remove Location",removeBtn.disabled=!1),swal.fire({title:"Saving Location",text:"Please wait while we save this location's data",icon:"info",showConfirmButton:!1,showCancelButton:!1,allowOutsideClick:()=>swal.isLoading(),didOpen:()=>{swal.showLoading(),saveLocationData(o).then(e=>{swal.hideLoading(),fillLocationData(this.dataset.currentTab,e),swal.fire({title:"Location Saved",text:`${e.location_name}'s data has been saved.`,icon:"success"})}).catch(e=>swal.showValidationMessage(e))}})):(removeBtn.disabled=!1,removeBtn.innerText="Discard")}),removeBtn.addEventListener("click",function(){let e=document.getElementById("variable-edit-btn"),t=e.dataset.currentTab;if(e.classList.contains("btn-success")){let e=document.getElementById(`location-info-${t}`),a=document.getElementById(`location-form-${t}`);$(e).collapse("toggle"),$(a).collapse("toggle"),this.innerText="Remove Location",1===tabCount?(this.innerText="Cannot Remove Only Location",this.disabled=!0):(this.innerText="Remove",this.disabled=!1)}else{let e=document.getElementById(`staticLocationName-${t}`).innerText;swal.fire({title:"Are you sure?",text:`Are you sure you want to delete the "${e}" location? This cannot be undone.`,icon:"warning",showConfirmButton:!0,showCancelButton:!0,showLoaderOnConfirm:!0,preConfirm:()=>deleteLocation(t).then(e=>e).catch(e=>handleGeneralError(e)),allowOutsideClick:()=>!swal.isLoading()}).then(t=>{if(t.isConfirmed){let a=t.value.location_id,n=[];n.push(document.getElementById(`location${a}`)),n.push(document.getElementById(`location${a}-tab`)),n.forEach(e=>e.remove()),1===--tabCount&&(this.innerText="Cannot Remove Only Location",this.disabled=!0),swal.fire({title:`${e} Removed`,text:"This location has been removed from the franchise.",icon:"success"});let o=document.querySelectorAll(".location-tab-btn")[0];$(o).tab("show")}})}});const deleteLocation=async e=>{let t=await fetch(`/locations/delete/${e}`,{method:"post",headers:{Accept:"application/json","X-Csrf-Token":csrfToken}});if(!t.ok)throw new Error("Could not delete location");return t.json()};